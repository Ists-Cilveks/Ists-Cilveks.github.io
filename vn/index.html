<!DOCTYPE html>
<html>
	<head>
		<title>TEST TEST TEST</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="/css/style.css" rel="stylesheet">
		<link href="vn.css" rel="stylesheet">
	</head>
	<body class="main-content">
	
	<script src="/js/Color.js"></script>
	<script src="/css/palettize.js"></script>
	<script src="/js/particles.js"></script>
	<script src="/js/SVGRequests.js"></script>
	
  <header id="main-header">
  </header>
  <script src="/js/languages.js" my-languges="en"></script>

  <div id="vn-textbox" onclick="progressText()">
    <p>Click to progress the text. This likely won't work with screen readers.</p>
  </div>

  <div id="all-vn-content" style="display: none;"></div>

  <div id="vn-stage"></div>

  <script type="text/javascript">
    const textbox = document.getElementById('vn-textbox')
    const allContent = document.getElementById('all-vn-content')
    let currentContent
    let contentDiv

    const xhr = new XMLHttpRequest()
    xhr.open("GET", "test.html", true)
    xhr.responseType = "document"
    xhr.onload = function(e) {
      let myDoc = xhr.responseXML.documentElement
      allContent.appendChild(myDoc)
      contentDiv = document.getElementById("vn-content").firstElementChild
    }
    xhr.send("")

    var characters = []
    class Character {
      constructor(name, displayName, accessibleName, container, svgPath) {
        this.name = name
        this.displayName = displayName
        this.accessibleName = accessibleName
        // TODO: <span role="img" aria-label="Kit">K¡t</span>
        if (container) {
          this.container = container
        } else {
          this.container = document.createElement("div")
          this.container.className = "characer-container"
          this.container.id = name+"-container"
          document.getElementById("vn-stage").appendChild(this.container)
        }
        if (svgPath) {
          insertSVG(svgPath, this.container, function(e, characterSVG) {
            characterSVG.setAttribute("height", "80vh") // FIXME: images should be scaled equally (bigger images remain bigger), instead of all being a certain height
            characterSVG.removeAttribute("width")
          })
        }
        this.expression = "neutral"
      }

      setExpression (newExp) {
        const currentExpressionID = this.name+"-"+this.expression
        const newExpressionID = this.name+"-"+newExp
        document.getElementById(currentExpressionID).style.display = "none"
        document.getElementById(newExpressionID).style.display = "inline"
        this.expression = newExp
      }
    }
    
    characters.push(new Character("kit", "K¡t", "Kit", undefined, "kit/kit.svg"))

    function progressText() {
      // Get next element
      let newContent = contentDiv.firstElementChild
      if (!newContent) {
        newContentDiv = contentDiv.nextElementSibling
        if(!newContentDiv) { // out of content
          return
        }
        contentDiv = newContentDiv
        newContent = contentDiv.firstElementChild
      }

      // Replace
      textbox.textContent = ""
      textbox.appendChild(newContent)
      currentContent = newContent

      // Look for expressions
      const classes = currentContent.className.split(" ")
      for (const char of characters) {
        let emotion
        for (const cl of classes) {
          if (cl.startsWith(char.name+"-")) {
            emotion = cl.slice(char.name.length+1)
            break
          }
        }
        
        if (emotion) {
          char.setExpression(emotion)
        }
      }
    }
  </script>
	</body>
</html>